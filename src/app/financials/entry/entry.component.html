
<!-- Only want spinner to show when a category has been selected -->
<div *ngIf="!formReady && currentCategory else entry"> 
    <app-progress-spinner></app-progress-spinner>
</div>

<ng-template #entry>
    
    <div *ngIf="currentCategory && (startingBalance || startingBalance == 0)">
        
        <mat-card>

            <div class="desktop">
                <strong>{{currentCategory.val | uppercase}} </strong>
                <span style="color:darkgray;"> Starting Balance: {{startingBalance | currency}} | </span>
                <!-- <span *ngIf="currentCategory.key === 'tuition' && tuitionRequiredMonthlyPayment">
                    <span class="monthly-payment">Required Monthly Pymt.: {{tuitionRequiredMonthlyPayment | currency}}</span> |</span> -->
                Balance Due: <span [class.credit] = "balanceIsNegative">{{runningBalance | currency}} </span>
                <span *ngIf="balanceIsNegative" class="credit"> (Student Credit)</span>
                <button *ngIf="(paymentsCollectionExists || chargesCollectionExists) && currentCategory" mat-flat-button color="primary" type="button" (click)="toggleHistory()">View History</button>
            </div>

            <div class="mobile">
                <strong>{{currentCategory.val | uppercase}} </strong>  <button *ngIf="(paymentsCollectionExists || chargesCollectionExists) && currentCategory" mat-flat-button color="primary" type="button" (click)="toggleHistory()">View History</button>
                <div style="color:darkgray;"> Starting Balance: {{startingBalance | currency}}  </div>
                <span *ngIf="currentCategory.key === 'tuition' && tuitionRequiredMonthlyPayment" class="monthly-payment"> Required Monthly Pymt.: {{tuitionRequiredMonthlyPayment | currency}}</span>
                <div>Balance Due: <span [class.credit] = "balanceIsNegative">{{runningBalance | currency}} </span> <span *ngIf="balanceIsNegative" class="credit"> (Student Credit)</span></div>
    
            </div>

        </mat-card>
        
    </div>
            
    <p *ngIf="currentCategory && !user['roles'].admin && showStartingBalanceInput">Financial data for {{currentCategory.val}} is pending.</p>

    <mat-card *ngIf="currentCategory && user.roles.admin">

        <form [formGroup]="formGroup" #formDirective="ngForm" (ngSubmit)="submitHandler(formDirective)">

            <!-- Now that form is ready, check for a starting balance to determine which form controls to show -->   

            <div *ngIf="showStartingBalanceInput else transaction">  
                <h5>Enter financials for {{currentCategory.val}}</h5>
                <mat-form-field>
                    <input matInput type=number step=0.01 placeholder="{{currentCategory.val}} Start Bal." formControlName="amount">
                </mat-form-field>

                <!-- Ideally, tuition required monthly payment would only be entered upon enter a starting balance for a student, however, 
                this needs to be done for students with starting balance already present. -->
                <mat-form-field *ngIf="currentCategory.key === 'tuition' && !tuitionRequiredMonthlyPayment">
                    <input matInput type=number step=0.01 placeholder="Required Monthly Pymt." formControlName="tuitionRequiredMonthlyPayment">
                </mat-form-field>

            </div>
    
            <ng-template #transaction>
                <div>
                    <button mat-flat-button type="button" (click)="enterPayment()">Enter Payment</button>
                    <button mat-flat-button type="button" (click)="enterCharge()">Enter Charge</button>
                </div>

                <p style="font-size:1em;" *ngIf="(currentCategory.key === 'tuition' && isEnteringCharge)">Tuition charge will be divided into 10 monthly charges and the tuition memo will be auto generated.</p>

                <!-- <mat-form-field *ngIf="currentCategory.key === 'tuition' && !tuitionRequiredMonthlyPayment && (isEnteringPayment || isEnteringCharge)">
                    <input matInput type=number step=0.01 placeholder="Required Monthly Pymt." formControlName="tuitionRequiredMonthlyPayment">
                </mat-form-field> -->

                <ng-container *ngIf="isEnteringPayment">
                    <mat-form-field>
                        <input matInput type=number step=0.01 placeholder="{{currentCategory.val}} Payment" formControlName="amount">
                    </mat-form-field>
                </ng-container>

                <ng-container *ngIf="isEnteringCharge">
                    <mat-form-field>
                        <input matInput type=number step=0.01 placeholder="{{currentCategory.val}} Charge" formControlName="amount">
                    </mat-form-field>
                </ng-container>
            </ng-template>

            <!-- Date picker and memo will show for entering balance, payment and charge -->
            
            <div *ngIf="showStartingBalanceInput || (isEnteringCharge || isEnteringPayment)">
                <mat-form-field>
                    <input matInput [matDatepicker]="transactionDatePicker" placeholder="Date" formControlName="date">
                    <mat-datepicker-toggle matSuffix [for]="transactionDatePicker"></mat-datepicker-toggle>
                    <mat-datepicker #transactionDatePicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field *ngIf="!(currentCategory.key === 'tuition' && isEnteringCharge)">
                    <input matInput type=text placeholder="Memo" formControlName="memo">
                </mat-form-field>         
            </div>
            
            <mat-checkbox *ngIf="isEnteringPayment && 
            (currentCategory.key === 'tuition' ||
            currentCategory.key === 'extendedCare' ||  
            currentCategory.key === 'misc')" 
            formControlName="taxDeductionEligible">
            Tax deduction eligible
            </mat-checkbox> 

            <button mat-flat-button color="primary" [disabled]="!formGroup.valid || disableSubmitButton" type="submit">Submit</button>
        </form>
    </mat-card>
    
</ng-template>
    